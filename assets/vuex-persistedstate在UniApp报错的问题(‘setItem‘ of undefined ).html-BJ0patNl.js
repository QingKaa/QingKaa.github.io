import{_ as c,r as a,o as i,c as l,b as e,a as n,d as s,e as t}from"./app-BGeYGDUW.js";const r="/assets/old-LjH_SRVB.png",u="/assets/log-window-h3iep8Ir.png",d={},k=n("h1",{id:"vuex-persistedstate-在uniapp报错的问题-setitem-of-undefined",tabindex:"-1"},[n("a",{class:"header-anchor",href:"#vuex-persistedstate-在uniapp报错的问题-setitem-of-undefined"},[n("span",null,"vuex-persistedstate 在UniApp报错的问题(‘setItem‘ of undefined )")])],-1),v=t(`<blockquote><p>遇到问题不害怕，无需着急；冷静下来慢慢分析、定位问题。</p></blockquote><h2 id="报错" tabindex="-1"><a class="header-anchor" href="#报错"><span>报错</span></a></h2><p>起因：真机调试运行时报错:</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code>reportJSException <span class="token operator">&gt;&gt;&gt;</span><span class="token operator">&gt;</span> exception <span class="token keyword">function</span><span class="token operator">:</span>createInstanceContext<span class="token punctuation">,</span> <span class="token literal-property property">exception</span><span class="token operator">:</span>white screen cause create instanceContext failed<span class="token punctuation">,</span>check js stack <span class="token operator">-</span><span class="token operator">&gt;</span>Uncaught TypeError<span class="token operator">:</span> Cannot read property <span class="token string">&#39;setItem&#39;</span> <span class="token keyword">of</span> <span class="token keyword">undefined</span>  
</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div></div></div><p>这个问题并不会在网页调试、小程序调试中出现，只会在真机调试中出现。单看报错信息也是非常的懵：拿到两个关键词<code>setItem</code> 、<code>undefined</code>。太模糊了，根本没办法定位(当时一般是在网页开发完后到真机上调试，所以vuex-persistedstate这个插件是一开始就以及安装用上的了，也没发现问题，一开始也没有往这个东西上想)。</p><p>具体排查过程不详细说了（花费了不少时间最后才定位到时<code>vuex-persistedstate</code>的问题）。此文主要是总结记录、分享。</p><p>先来看一下报错的写法：<br><img src="`+r+'" alt="错误的写法"></p><p>一般开发 <strong>网页项目</strong> 这样写是不会有问题的。但是 ！！！<br> 到了App环境就会出现上面莫名的问题。</p><h2 id="问题根源" tabindex="-1"><a class="header-anchor" href="#问题根源"><span>问题根源</span></a></h2>',9),m=n("code",null,"vuex-persistedstate",-1),g=n("code",null,"window.localStorage",-1),b=n("br",null,null,-1),f={href:"https://github.com/robinvdvleuten/vuex-persistedstate",target:"_blank",rel:"noopener noreferrer"},_=n("br",null,null,-1),h=n("code",null,"index.ts",-1),y=t(`<div class="language-typescript line-numbers-mode" data-ext="ts" data-title="vuex-persistedstate/index.ts"><pre class="language-typescript"><code><span class="token comment">// 源码34行：</span>
<span class="token keyword">const</span> storage <span class="token operator">=</span> options<span class="token punctuation">.</span>storage <span class="token operator">||</span> <span class="token punctuation">(</span>window <span class="token operator">&amp;&amp;</span> window<span class="token punctuation">.</span>localStorage<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// 源码53行</span>
<span class="token keyword">function</span> <span class="token function">setState</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> state<span class="token punctuation">,</span> storage<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> storage<span class="token punctuation">.</span><span class="token function">setItem</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">stringify</span><span class="token punctuation">(</span>state<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在栏看看真机运行时候<code>window</code>是个啥，打印输出：<br><img src="`+u+`" alt="log-window"></p><p><strong>真机运行时候<code>window</code>对象是<code>undefined</code>。</strong></p><p>问题根源找到了~~</p><h2 id="解决方法" tabindex="-1"><a class="header-anchor" href="#解决方法"><span>解决方法</span></a></h2><p><code>persistedState</code>是接收一个 <code>Options</code> 参数的。把 <code>Storage</code> 的参数写一下，用上 <code>uniapp</code>特有的<code>api</code>。</p><div class="language-javascript line-numbers-mode" data-ext="js" data-title="js"><pre class="language-javascript"><code><span class="token keyword">import</span> Vue <span class="token keyword">from</span> <span class="token string">&#39;vue&#39;</span>
<span class="token keyword">import</span> Vuex <span class="token keyword">from</span> <span class="token string">&#39;vuex&#39;</span>
Vue<span class="token punctuation">.</span><span class="token function">use</span><span class="token punctuation">(</span>Vuex<span class="token punctuation">)</span>
<span class="token comment">//引入vuex-persistedstate</span>
<span class="token keyword">import</span> persistedState <span class="token keyword">from</span> <span class="token string">&quot;vuex-persistedstate&quot;</span><span class="token punctuation">;</span>
<span class="token keyword">import</span> pricedetail <span class="token keyword">from</span> <span class="token string">&#39;./pricedetail.js&#39;</span>

<span class="token keyword">const</span> store <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Vuex<span class="token punctuation">.</span>Store</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
	<span class="token literal-property property">state</span><span class="token operator">:</span> pricedetail<span class="token punctuation">.</span>state<span class="token punctuation">,</span>
	<span class="token literal-property property">getters</span><span class="token operator">:</span> pricedetail<span class="token punctuation">.</span>getters<span class="token punctuation">,</span>
	<span class="token literal-property property">mutations</span><span class="token operator">:</span> pricedetail<span class="token punctuation">.</span>mutations<span class="token punctuation">,</span>
	<span class="token literal-property property">actions</span><span class="token operator">:</span> pricedetail<span class="token punctuation">.</span>actions<span class="token punctuation">,</span>

	<span class="token literal-property property">plugins</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token function">persistedState</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
        <span class="token comment">// 传入参数</span>
		<span class="token literal-property property">storage</span><span class="token operator">:</span> <span class="token punctuation">{</span>
			<span class="token function-variable function">getItem</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> uni<span class="token punctuation">.</span><span class="token function">getStorageSync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token function-variable function">setItem</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">key<span class="token punctuation">,</span> val</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> uni<span class="token punctuation">.</span><span class="token function">setStorageSync</span><span class="token punctuation">(</span>key<span class="token punctuation">,</span> value<span class="token punctuation">)</span><span class="token punctuation">,</span>
			<span class="token function-variable function">removeItem</span><span class="token operator">:</span> <span class="token punctuation">(</span><span class="token parameter">key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> uni<span class="token punctuation">.</span><span class="token function">removeStorageSync</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span>
		<span class="token punctuation">}</span>
	<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>

<span class="token keyword">export</span> <span class="token keyword">default</span> store

</code></pre><div class="line-numbers" aria-hidden="true"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>END</p>`,8);function x(w,I){const p=a("PostInfo"),o=a("ExternalLinkIcon");return i(),l("div",null,[k,e(p),v,n("blockquote",null,[n("p",null,[s("原因在于 "),m,s("默认配置是使用 "),g,s("。"),b,s(" 为了求证特意去看了源码，仓库地址 "),n("a",f,[s("vuex-persistedstate"),e(o)]),_,s(" 源码也非常少，只有一个"),h,s("文件。")])]),y])}const S=c(d,[["render",x],["__file","vuex-persistedstate在UniApp报错的问题(‘setItem‘ of undefined ).html.vue"]]),E=JSON.parse('{"path":"/blog/uniApp/vuex-persistedstateInUniApp/vuex-persistedstate%E5%9C%A8UniApp%E6%8A%A5%E9%94%99%E7%9A%84%E9%97%AE%E9%A2%98(%E2%80%98setItem%E2%80%98%20of%20undefined%20).html","title":"vuex-persistedstate在UniApp报错的问题(‘setItem‘ of undefined )","lang":"zh-CN","frontmatter":{"title":"vuex-persistedstate在UniApp报错的问题(‘setItem‘ of undefined )","date":"2022-06-21","tags":["uniApp","vuex-persistedstate"],"poster":"/images/poster/vuex-persistedstate_poster.jpg","author":"清咖","category":"uniApp"},"headers":[{"level":2,"title":"报错","slug":"报错","link":"#报错","children":[]},{"level":2,"title":"问题根源","slug":"问题根源","link":"#问题根源","children":[]},{"level":2,"title":"解决方法","slug":"解决方法","link":"#解决方法","children":[]}],"git":{"updatedTime":1714378029000,"contributors":[{"name":"清咔","email":"874518796@qq.com","commits":1}]},"filePathRelative":"blog/uniApp/vuex-persistedstateInUniApp/vuex-persistedstate在UniApp报错的问题(‘setItem‘ of undefined ).md"}');export{S as comp,E as data};
